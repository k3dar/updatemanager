#!/bin/sh
# postinst script for updatemanager
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#

case "$1" in
    configure)
	DIR="/usr/lib/solydxk/updatemanager"
	if [ ! -e "$DIR/files" ]; then
	  mkdir -p "$DIR/files"
	fi
	if [ -e "$DIR/updatemanager.conf" ]; then
	  mv -f "$DIR/updatemanager.conf" "$DIR/files/"
	fi
	if [ -e "$DIR/updatemanager.hist" ]; then
	  mv -f "$DIR/updatemanager.hist" "$DIR/files/"
	fi
	if [ -e "$DIR/mirrors.list" ]; then
	  mv -f "$DIR/mirrors.list" "$DIR/files/"
	fi
	if [ -e "$DIR/*.sh" ]; then
	  mv -f "$DIR/*.sh" "$DIR/files/"
	fi
	chmod -R 777 "$DIR/files"
	chmod 755 "$DIR/updatemanager.py"
	chmod 755 "$DIR/updatemanagerpref.py"
	chmod 755 "$DIR/updatemanagertray.py"
	chmod 755 "/usr/bin/updatemanager"
	
	if [ -e "$DIR/files/updatemanager.hist" ]; then
	  sed -i 's/up=/upd=/g' "$DIR/files/updatemanager.hist"
	fi
	
	if [ -f /etc/xdg/autostart/updatemanager.desktop ]; then
	  rm /etc/xdg/autostart/updatemanager.desktop
	fi
	
	/usr/lib/solydxk/system/adjust.py
	
	CONF='/usr/lib/solydxk/updatemanager/files/updatemanager.conf'
	if [ -e $CONF ]; then
	  sed -i -e 's/solydxk\s*=.*/solydxk = http:\/\/repository.solydxk.com/' $CONF
	  sed -i -e 's/mirrors-list\s*=.*/mirrors-list = http:\/\/repository.solydxk.com\/umfiles\/mirrors.list/' $CONF
	  sed -i -e 's/dl-test\s*=.*/dl-test = README.mirrors.html/' $CONF
	  sed -i -e '/^solydxk-debian\s*=/d' $CONF
	  sed -i -e '/^debian\s*=/d' $CONF
	  sed -i -e '/.*stable.*/d' $CONF
	  sed -i -e '/.*emergency.*/d' $CONF
	  sed -i -e '/.*testing.*/d' $CONF
	  sed -i -e '/^up-info\s*=/d' $CONF
	  sed -i -e '/.*-up\s*=/d' $CONF
	  sed -i -e '/^umfilessubdir.*/d' $CONF
	fi
	
	CONF='/etc/apt/apt.conf.d/80updatemanager'
	if [ -e $CONF ]; then
	  rm $CONF
	fi
	
	# Create group
	#addgroup --quiet updatemanager
	# Add existing users to group
	#USERS=$(cat /etc/passwd | grep bash | grep home | cut -d':' -f 1)
	#for USER in $USERS; do
	#  usermod -aG updatemanager $USER
	#done
	# Add group to sudoers
	#echo "%updatemanager ALL=(ALL) NOPASSWD:/usr/bin/updatemanager" > /etc/sudoers.d/updatemanager
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


